# HSSBLogger Log File Format 取り扱いガイドライン

## 目次

1. [目次](#目次)
2. [はじめに](#はじめに)
3. [前提](#前提)
4. [用語](#用語)
   1. [PID](#pid)
   2. [ログのローテート](#ログのローテート)
5. [ログファイルのローテートについて](#ログファイルのローテートについて)
   1. [多重起動を許可しないアプリケーションの場合](#多重起動を許可しないアプリケーションの場合)
   2. [多重起動を許可するアプリケーションの場合](#多重起動を許可するアプリケーションの場合)
6. [ログファイルの収集と整理について](#ログファイルの収集と整理について)
   1. [ユーザーに委任する方法](#ユーザーに委任する方法)
   2. [専用のソフトウェア(GCツール)にて実施する方法](#専用のソフトウェアgcツールにて実施する方法)
      1. [整理を行うフォルダやファイルが正しいこと](#整理を行うフォルダやファイルが正しいこと)
      2. [GCツールは多重起動や整理プロセスが同時に実行されることを防止すること](#gcツールは多重起動や整理プロセスが同時に実行されることを防止すること)
      3. [ログを出力するアプリケーションが実行されておらず、また、ファイルの整理中に実行されないこと](#ログを出力するアプリケーションが実行されておらずまたファイルの整理中に実行されないこと)
   3. [ログを生成するアプリケーションにて実施する方法 (多重起動を許可しないアプリケーションの場合)](#ログを生成するアプリケーションにて実施する方法-多重起動を許可しないアプリケーションの場合)
   4. [ログを生成するアプリケーションにて実施する方法 (多重起動を許可するアプリケーションの場合)](#ログを生成するアプリケーションにて実施する方法-多重起動を許可するアプリケーションの場合)
7. [Appendix](#appendix)
   1. [多重起動を防止する方法](#多重起動を防止する方法)


## はじめに

このファイルは [LogFileFormatSpec.md](LogFileFormatSpec.md) にて定義されている HSSBLogger Log File Format に基づき
ログファイルの取り扱いに関するガイドラインを提供します。ログファイルの正しい取り扱いは、システムの監視、トラブルシューティング、パフォーマンス分析において重要です。
本ガイドラインでは、ログファイルのローテートや収集・整理といった、ログファイルの取り扱いに関する具体的な注意点を説明します。


> [!TIP]
> HSSBLogger Log File Formatは HSSBLoggerで使用されるログファイルフォーマットの名称になります。
> 本書上では、『HSSBLoggerのログファイル』や『HSSBLoggerのログファイルフォーマット』と表記する場合があります。


## 前提

HSSBLogger のログファイルは、設計上、複数のプロセスから同時に書き込みが行われることは想定されていません。

想定していない根拠の一つとして、PID(プロセスID)やSHA256ハッシュをヘッダー部に保有していることが挙げられます。
また、ログファイルはバイナリファイルであり、また、やや複雑なセクション構造を持つため、他のプロセスからの
書き込みが発生すると、ログファイルが簡単に破損いたします。

そのため、多重起動を許可するアプリケーションの場合は、それぞれのプロセスでログファイルを分ける必要があります。


## 用語


### PID

PIDはプロセスIDを示し、オペレーティングシステムによって各プロセスに割り当てられる一意の識別子です。

なお、Windows APIでは[GetCurrentProcessId関数](https://learn.microsoft.com/ja-jp/windows/win32/api/processthreadsapi/nf-processthreadsapi-getcurrentprocessid)を用いてこの値を取得できます。


### ログのローテート

本ガイドラインにおける「ログファイルのローテート」とは、

既存のログファイルを別の名前に変更したり、サブフォルダなどの他のフォルダに退避してから、

新しいログファイルへの出力を開始することを指します。

> [!NOTE]
> 本ガイドラインでは、ファイルサイズに基づくローテートについては扱いません。

## ログファイルのローテートについて


### 多重起動を許可しないアプリケーションの場合

最も安全なタイミングは、アプリケーションの起動時です。アプリケーションが起動するたびに、新しいログファイルを作成し、古いログファイルはローテート(名前変更など)をします。
なお、後述する「多重起動を許可するアプリケーションの場合」と同様に、古いファイルをローテートするのではなく、ログファイル名にタイムスタンプを含めるのも有効です。


> [!TIP]
> アプリケーション起動時が最も安全なタイミングである理由は以下の通りです
>
> ログファイルへの書き込みがないことが保証されているため、ログファイルの整合性が保たれます。


### 多重起動を許可するアプリケーションの場合

> [!IMPORTANT]
> 実装上の注意点として以下のような状況は避けてください。
>
> - 複数のプロセスが同じログファイルに書き込む。
> - ログ出力中にログファイルのローテートを行う　(これは、外部ツールでローテーションを行う場合も含みます)


多重起動を許可する場合、複数のプロセスからログの出力先にアクセスされることになるため、ログファイルのローテートはしないでください。

その代わり、ログファイル名にプロセスIDやタイムスタンプを含めることで、毎回異なるファイル名のファイルを作成してください。

> [!TIP]
> PIDはプロセス終了後に再利用される可能性があります、そのため、タイムスタンプなどの追加情報を含めることを強く推奨します。



例えば、以下のようなファイル名です。

```
AppLog_PID45404_20251223_003015.blog
AppLog_45404_20251223_003015.blog
```


## ログファイルの収集と整理について

> [!IMPORTANT]
> 本書では、以下の内容には言及しません。
>
> * 保存期間
> * 収集や整理の対象の選定
>   - 例えば、7日以上経過したものを収集するといった具体的なことは本書では定義いたしません。別途検討してください。



ログファイルの収集と整理については、誰が実施するかによって注意事項が異なります。

本書が想定するケースの概要は以下です。

1. ユーザーに委任する方法
2. 専用のソフトウェアにて実施する方法 (以後、GCツールと呼称します)
3. ログを生成するアプリケーションにて実施する方法 (多重起動を許可しないアプリケーションの場合)
4. ログを生成するアプリケーションにて実施する方法 (多重起動を許可するアプリケーションの場合)


順番に解説いたします。

### ユーザーに委任する方法


ユーザーにログファイルの収集と整理を委任する場合、以下の点をユーザーに周知してください。

* ログを生成するアプリケーションが起動していない状態で実施すること
    - ログファイルが書き込み中に収集や整理を行うと、ログファイルが破損する可能性があります


> [!IMPORTANT]
> ロガー側では、出力する可能性がある間はログファイルをロックすることを検討してください。
> これにより、ユーザーが誤ってログファイルを操作しようとした場合にエラーが発生し、ログファイルの破損を防止できます。
>
> これを実現する簡単な方法は[CreateFile関数](https://learn.microsoft.com/ja-jp/windows/win32/api/fileapi/nf-fileapi-createfilea)の`dwShareMode`パラメーターに FILE_SHARE_WRITEとFILE_SHARE_DELETEを指定しないでログを作成することです。
> これにより、他のプロセスによるファイル書き込み及び削除を防止できます。


### 専用のソフトウェア(GCツール)にて実施する方法

専用のソフトウェア(GCツール)にて実施する方法の場合、以下の点を考慮・注意する必要があります。

* 整理を行うフォルダやファイルが正しいこと
* GCツールは多重起動や整理プロセスが同時に実行されることを防止すること
* ログを出力するアプリケーションが実行されておらず、また、ファイルの整理中に実行されないこと

#### 整理を行うフォルダやファイルが正しいこと

HSSBLoggerのログファイルの先頭は以下のようなUUID群で始まります。
詳細は、[LogFileFormatSpec.md の「ヘッダーセクション」の説明](LogFileFormatSpec.md#ヘッダーセクション)を参照してください。


```cpp
UUID                  FormatID;                        // フォーマット識別子
UUID                  FormatVersionID;                 // フォーマットバージョン識別子
UUID                  ImplementerID;                   // 実装者識別子
UUID                  LoggerID;                        // ロガー実装識別子
UUID                  ApplicationID;                   // アプリケーション識別子
```

そのため、これらの情報を確認し、対象と判断できたファイルのみ処理を実施してください。

また、HSSBLoggerのログファイルフォーマットでは外部ファイルは定義しておりませんが、
アプリケーション定義の付随データがある場合は、何らかの形で対象であることを識別できる
ようにすることを推奨します。

#### GCツールは多重起動や整理プロセスが同時に実行されることを防止すること




#### ログを出力するアプリケーションが実行されておらず、また、ファイルの整理中に実行されないこと


### ログを生成するアプリケーションにて実施する方法 (多重起動を許可しないアプリケーションの場合)


### ログを生成するアプリケーションにて実施する方法 (多重起動を許可するアプリケーションの場合)


## Appendix

### 多重起動を防止する方法

* TBD (サンプルコードを掲載予定)